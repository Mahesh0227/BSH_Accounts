<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BSH EXPENSES â€” Auth</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>


<style>
    :root{
      --bg-left: #eaf6ff;
      --bg-right: #f7fbff;
      --brand-blue: #2f8afc;
      --brand-blue-600: #2878e6;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --info-bg: #e7f1ff;
      --soft-shadow: 0 8px 30px rgba(16,24,40,0.06);
    }
    body {
      background: linear-gradient(90deg, var(--bg-left) 0%, var(--bg-right) 100%);
      -webkit-font-smoothing: antialiased;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .glass { background: rgba(255,255,255,0.94); backdrop-filter: blur(6px); }
    .card { box-shadow: var(--soft-shadow); border-radius: 14px; border: 1px solid rgba(15, 23, 42, 0.04); }
    .info-box { background: linear-gradient(180deg, rgba(248,253,255,1) 0%, rgba(231,241,255,1) 100%); border-radius: 10px; border: 1px solid rgba(47,138,252,0.08); }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 4px rgba(47,138,252,0.08); border-color: var(--brand-blue-600); }
    .brand-icon { width: 56px; height: 56px; border-radius: 9999px; background: linear-gradient(180deg,#58a4ff,#2f8afc); display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 18px rgba(47,138,252,0.18); }
    .fade { transition: all .22s ease; }
    .hidden-scale { transform: scale(.98); opacity: 0; height: 0; overflow: hidden; pointer-events: none; }
    .visible-scale { transform: scale(1); opacity: 1; height: auto; pointer-events: auto; }
    form.fade { transition: opacity .22s ease, transform .22s ease, height .22s ease; }
    @media (max-width: 420px) { .card { padding-left: 18px; padding-right: 18px; } }
    .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); border-top-color: rgba(255,255,255,0.9); animation: spin 0.8s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .msg { margin-top: 12px; font-size: 0.9rem; }
  </style>

</head>
<body class="min-h-screen flex items-start justify-center py-12 px-6">

  <div class="w-full max-w-5xl">

    <!-- header -->
    <div class="flex flex-col items-center mb-8">
      <div class="brand-icon mb-4" aria-hidden>
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
          <path d="M3 17h3v4H3v-4zM9 11h3v10H9V11zM15 5h3v16h-3V5z" fill="white"/>
        </svg>
      </div>

      <h1 class="text-3xl font-extrabold" style="color:var(--brand-blue);">BSH EXPENSES</h1>
      <p class="text-sm mt-2 text-gray-500 max-w-[640px] text-center">Manage your income, expenses, and savings efficiently</p>
    </div>

    <!-- card -->
    <div class="flex justify-center">
      <div id="authCard" class="card glass w-full max-w-[420px] p-6">
        <div class="flex flex-col items-center">
          <h2 id="cardTitle" class="text-xl font-semibold text-slate-800">Welcome Back</h2>
          <p id="cardSubtitle" class="text-sm text-gray-500 mt-1">Sign in to your account or create a new one</p>
        </div>

        <!-- info box -->
        <div class="info-box mt-6 p-3 text-sm text-slate-700">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5">
              <div class="w-8 h-8 rounded-full bg-white/60 flex items-center justify-center border border-white/40">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2l7 3v5c0 5-3.7 9.8-7 11-3.3-1.2-7-6-7-11V5l7-3z" fill="#2f8afc"/>
                </svg>
              </div>
            </div>

            <div class="flex-1">
              <div class="font-medium text-slate-800">Security Features Active</div>
              <ul class="mt-2 text-xs text-slate-700 list-disc pl-4 space-y-0.5">
                <li>Input validation and sanitization</li>
                <li>Rate limiting protection</li>
                <li>Secure authentication with Supabase</li>
                <li>Row-level security policies</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- tabs -->
        <div class="mt-6 w-full flex items-center gap-3" role="tablist" aria-label="Sign in or sign up">
          <button id="btnSignIn" aria-controls="formSignIn" role="tab" class="flex-1 py-2 rounded-md bg-[var(--brand-blue)] text-white font-semibold">Sign In</button>
          <button id="btnSignUp" aria-controls="formSignUp" role="tab" class="flex-1 py-2 rounded-md bg-slate-100 text-slate-700 font-medium">Sign Up</button>
        </div>

        <!-- Sign In form -->
        <form id="formSignIn" class="mt-5 space-y-4 fade visible-scale">

          <div>
            <label class="text-xs font-medium text-slate-600">Email Address</label>
            <div class="mt-2 relative">
              <input name="email" type="email" required placeholder="Enter your email address"
                     class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white text-sm" />
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-600">Password</label>
            <div class="mt-2 relative">
              <input id="signinPassword" name="password" type="password" required minlength="6"
                     placeholder="Enter your password" class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white text-sm pr-12" />
              <button type="button" data-toggle-for="signinPassword" aria-label="Show password"
        class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 toggle-btn">
  <!-- Icons will be injected by JS -->
</button>
          </div>

          <div class="flex items-center justify-between text-sm">
            <label class="inline-flex items-center gap-2 text-slate-600">
              <input type="checkbox" name="remember" class="h-4 w-4 rounded border-gray-300" />
              Remember me
            </label>
            <a href="#" class="text-slate-600 hover:underline">Forgot your password?</a>
          </div>

          <div>
            <button id="signinSubmit" type="submit" class="w-full py-3 rounded-lg bg-[var(--brand-blue)] hover:bg-[var(--brand-blue-600)] text-white font-semibold flex items-center justify-center gap-2">
              <span id="signinLabel">Sign In</span>
            </button>
          </div>
        </form>

        <!-- Sign Up form (hidden by default) -->
        <form id="formSignUp" class="mt-5 space-y-4 fade hidden-scale">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <label class="text-xs font-medium text-slate-600">Email Address</label>
              <input name="email" type="email" required placeholder="Enter your email address" class="mt-2 w-full px-4 py-3 rounded-lg border border-gray-200 bg-white text-sm" />
            </div>

          <div class="mt-2 relative">
  <input id="signupPassword" name="password" type="password" required minlength="8"
         placeholder="Create a strong password"
         class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white text-sm pr-12" />
  <button type="button" data-toggle-for="signupPassword" aria-label="Show password"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 toggle-btn">
    <!-- Icons injected by JS -->
  </button>
</div>

    <div class="mt-2 relative">
  <input id="signupConfirm" name="confirmPassword" type="password" required minlength="8"
         placeholder="Repeat password"
         class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white text-sm pr-12" />
  <button type="button" data-toggle-for="signupConfirm" aria-label="Show password"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 toggle-btn">
    <!-- Icons injected by JS -->
  </button>
</div>

            <div class="sm:col-span-2 flex items-center gap-2">
              <input id="terms" name="terms" type="checkbox" required class="h-4 w-4 rounded border-gray-300" />
              <label for="terms" class="text-sm text-slate-600">I agree to the <a href="#" class="text-indigo-600 underline">Terms & Conditions</a></label>
            </div>

            <div class="sm:col-span-2">
              <button id="signupSubmit" type="submit" class="w-full py-3 rounded-lg bg-[var(--brand-blue)] hover:bg-[var(--brand-blue-600)] text-white font-semibold flex items-center justify-center gap-2">
                <span id="signupLabel">Create Account</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5l7 7-7 7" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
          </div>
        </form>

        <div id="msg" class="mt-6 text-center text-red-600"></div>
        <div class="mt-6 text-center text-xs text-slate-400">Secure financial management for professionals</div>

      </div>
    </div>
  </div>


<script>
/* ================= TOGGLE ================= */
const btnSignIn = document.getElementById("btnSignIn");
const btnSignUp = document.getElementById("btnSignUp");
const formSignIn = document.getElementById("formSignIn");
const formSignUp = document.getElementById("formSignUp");

btnSignIn.onclick = () => {
  formSignIn.classList.replace("hidden-scale","visible-scale");
  formSignUp.classList.replace("visible-scale","hidden-scale");
};

btnSignUp.onclick = () => {
  formSignUp.classList.replace("hidden-scale","visible-scale");
  formSignIn.classList.replace("visible-scale","hidden-scale");
};

/* ================= LOGIN ================= */
formSignIn.addEventListener("submit", async e => {
  e.preventDefault();
  try {
    const data = await apiFetch("/auth/login", {
      method: "POST",
      body: JSON.stringify({
        email: e.target.email.value,
        password: e.target.password.value
      })
    });

     // âœ… FIX START
    localStorage.setItem("bsh_token", data.token);
    localStorage.setItem("bsh_user", JSON.stringify(data.user));
    localStorage.setItem("bsh_role", data.user.role); // ðŸ”¥ IMPORTANT
    // âœ… FIX END

    window.location.href = "/admin/dashboard";
  } catch (err) {
    document.getElementById("msg").innerText = err.message;
  }
});

/* ================= REGISTER ================= */
formSignUp.addEventListener("submit", async e => {
  e.preventDefault();
  if (e.target.password.value !== e.target.confirmPassword.value) {
    return document.getElementById("msg").innerText = "Passwords do not match";
  }
  try {
    await apiFetch("/auth/register", {
      method: "POST",
      body: JSON.stringify({
        email: e.target.email.value,
        password: e.target.password.value
      })
    });
    document.getElementById("msg").innerText = "Registered successfully. Please login.";
    btnSignIn.click();
  } catch (err) {
    document.getElementById("msg").innerText = err.message;
  }
});
</script>
<script>
async function apiFetch(url, options = {}) {
  const token = localStorage.getItem("bsh_token");

  const res = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      ...(token ? { Authorization: "Bearer " + token } : {})
    }
  });

  const text = await res.text();
  let data;

  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    data = { message: text };
  }

  if (!res.ok) {
    throw new Error(data?.message || "API Error");
  }

  return data;
}
</script>

<script src="/public/js/api.js"></script>

<script>
  // Password toggle for both forms
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.innerHTML = `
      <svg class="eye-icon block" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
      <svg class="eye-slash-icon hidden" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a21.92 21.92 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a21.92 21.92 0 0 1-2.06 3.06"/>
        <path d="M1 1l22 22"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    `;

    btn.addEventListener('click', () => {
      const input = document.querySelector(`#${btn.dataset.toggleFor}`);
      if (input.type === 'password') {
        input.type = 'text';
        btn.querySelector('.eye-icon').classList.add('hidden');
        btn.querySelector('.eye-slash-icon').classList.remove('hidden');
        btn.setAttribute('aria-label', 'Hide password');
      } else {
        input.type = 'password';
        btn.querySelector('.eye-icon').classList.remove('hidden');
        btn.querySelector('.eye-slash-icon').classList.add('hidden');
        btn.setAttribute('aria-label', 'Show password');
      }
    });
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const signupBtn = document.getElementById("signupSubmit");
  const msg = document.getElementById("msg");

  try {
    const res = await fetch("/auth/admin-exists");
    const data = await res.json();

    if (data.adminExists === true) {
  signupBtn.disabled = true;
  signupBtn.classList.add("opacity-50", "cursor-not-allowed");
  msg.innerText = "Signup disabled: Admin already exists";
} else {
  signupBtn.disabled = false;
  signupBtn.classList.remove("opacity-50", "cursor-not-allowed");
  msg.innerText = "";
}

  } catch (err) {
    console.error("ADMIN CHECK FAILED:", err);
    signupBtn.disabled = false; // fail-safe
  }
});
</script>

</body>
</html>
